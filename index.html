<!doctype html>
<html lang="zh-CN">
  <head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>PS4Broadcast Control Panel</title>
  </head>
<body>
<p>Twitch Id:</p>
<input type="textbox" id="tid" style="width:30%">
<div id="rooms"></div>
<p><button onclick="addMore()">+</button></p>
<!--<p>Room Type:</p>
<select id="type" style="width:30%">
<option value="douyu">斗鱼</option>
<option value="bilibili">Bilibili</option>
<select>
<p>Room Id:</p>
<input type="textbox" id="rid" style="width:30%">
<p>URL:</p>
<input type="textbox" id="url" style="width:30%">
<p>CODE:</p>
<input type="textbox" id="code" style="width:30%">-->
<p><input type="button" value="Reset Living" onclick="resetLiving()">
<input type="button" value="Update & Restart" onclick="updateandrestart()"></p>
<p>Messages:</p>
<textarea id="messages" style="width:100%;height:400px">
</textarea>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/jquery-3.2.1.min.js"></script>
<script>
	Element.prototype.remove = function() {
    		this.parentElement.removeChild(this);
	}
	function Id(id){
		return document.getElementById(id);
	}
	var socket = io();
		socket.on("message", function(m){
			var  messages = document.getElementById("messages");
			if(messages.scrollHeight > 5000){
				messages.value = "";
			}
			messages.value = messages.value += m +"\n";
			messages.scrollTop = messages.scrollHeight;
		});

		socket.on("living", function(status){
			var  messages = document.getElementById("messages");
                        messages.value = messages.value += "LIVING STATUS: "+ status +"\n";
		});
			
		socket.on("lastState", function(lp){
			if(lp && lp.items){
				for(var l in lp.items){
					addMore(lp.items[l].rid, lp.items[l].url, lp.items[l].type);
				}
				$("#tid").val(lp.tid);
			}
		});
		socket.on("error", function(error){
			console.log(error);
		});

	var roomSeq = -1;
	var roomsKey = [];
	function addMore(rid,url,type){
		roomSeq ++;
		var n = $('<p id="_'+roomSeq+'">Room Type:'+
					'<select id="type_'+roomSeq+'" style="width:10%">'+
					'<option value="douyu" '+ (type=='douyu'?'selected':'') +'>斗鱼</option>'+
					'<option value="bilibili" '+ (type=='bilibili'?'selected':'') +'>Bilibili</option>'+
					'<select>'+
					'Room Id:'+
					'<input type="textbox" id="rid_'+roomSeq+'" style="width:10%" value="'+(rid ? rid : '')+'">'+
					'URL:'+
					'<input type="textbox" id="url_'+roomSeq+'" style="width:10%" value="'+(url ? url: '')+'">'+
					'CODE:'+
					'<input type="textbox" id="code_'+roomSeq+'" style="width:10%"><button onclick="removeRoom(\''+roomSeq+'\')">-</button></p>');
		$("#rooms").append(n);
		roomsKey[roomsKey.length] = roomSeq;
	}
	
	function removeRoom(id){
		document.getElementById("_"+id).remove();
	}

	function updateandrestart(){
		socket.emit("updateandrestart");
	}

	function resetLiving(){
		var  messages = document.getElementById("messages");
		messages.value = "";
		var data = {tid: Id("tid").value, items:[]};
		for(var i in roomsKey){
			var p = document.getElementById("_"+roomsKey[i]);
			if(p){
				data.items[data.items.length] = {
					rid: Id("rid_"+roomsKey[i]).value,
					url: Id("url_"+roomsKey[i]).value,
					code: Id("code_"+roomsKey[i]).value,
					type: Id("type_"+roomsKey[i]).options[Id("type_"+roomsKey[i]).selectedIndex].value
				};
			}
		}
		socket.emit("resetlive", data);
	}
</script>
</body>
</html>
